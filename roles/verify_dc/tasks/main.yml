---
- name: Derive pod number from inventory_name
  ansible.builtin.set_fact:
    pod_number: "{{ inventory_hostname | regex_search('p(\\d+)$', '\\1') | first }}"
    domain_prefix: "acs-p{{ inventory_hostname | regex_search('p(\\d+)$', '\\1') | first }}"

- name: Set domain name
  ansible.builtin.set_fact:
    domain_name: "{{ domain_prefix }}.local"

- name: "M1 L1.1 - Check ex.employee exists, disabled, not in Finance"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "ex.employee" -Properties Enabled,MemberOf -ErrorAction Stop
        $inFinance = ($u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name }) -contains "Finance"
        if ($u -and (-not $u.Enabled) -and (-not $inFinance)) {
          @{ pass = $true; reason = "ex.employee exists, disabled, not in Finance" }
        } else {
          $reasons = @()
          if ($u.Enabled) { $reasons += "still enabled" }
          if ($inFinance) { $reasons += "still in Finance" }
          @{ pass = $false; reason = "ex.employee: " + ($reasons -join ", ") }
        }
      } catch {
        @{ pass = $false; reason = "ex.employee not found: $_" }
      }
  register: m1_l11

- name: "M1 L1.2 - Check hr.user1 not in Finance, in HR"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "hr.user1" -Properties MemberOf -ErrorAction Stop
        $groups = $u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name }
        $inFinance = $groups -contains "Finance"
        $inHR = $groups -contains "HR"
        if ((-not $inFinance) -and $inHR) {
          @{ pass = $true; reason = "hr.user1 not in Finance, in HR" }
        } else {
          $reasons = @()
          if ($inFinance) { $reasons += "still in Finance" }
          if (-not $inHR) { $reasons += "not in HR" }
          @{ pass = $false; reason = "hr.user1: " + ($reasons -join ", ") }
        }
      } catch {
        @{ pass = $false; reason = "hr.user1 not found: $_" }
      }
  register: m1_l12

- name: "M1 L1.3 - Check it.helpdesk not in Domain Admins"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "it.helpdesk" -Properties MemberOf -ErrorAction Stop
        $groups = $u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name }
        $inDA = $groups -contains "Domain Admins"
        if (-not $inDA) {
          @{ pass = $true; reason = "it.helpdesk not in Domain Admins" }
        } else {
          @{ pass = $false; reason = "it.helpdesk still in Domain Admins" }
        }
      } catch {
        @{ pass = $false; reason = "it.helpdesk not found: $_" }
      }
  register: m1_l13

- name: "M2 L2.1 - Check new.user1 exists, enabled, correct OU, groups"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "new.user1" -Properties Enabled,DistinguishedName,MemberOf -ErrorAction Stop
        $enabled = $u.Enabled
        $groups = $u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name }
        if ($u -and $enabled) {
          @{ pass = $true; reason = "new.user1 exists, enabled, DN=$($u.DistinguishedName)" }
        } else {
          @{ pass = $false; reason = "new.user1 exists but disabled" }
        }
      } catch {
        @{ pass = $false; reason = "new.user1 not found: $_" }
      }
  register: m2_l21

- name: "M2 L2.2 - Check consult.user1 removed from Consulting, added to Sales"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "consult.user1" -Properties MemberOf -ErrorAction Stop
        $groups = $u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name }
        $inConsulting = $groups -contains "Consulting"
        $inSales = $groups -contains "Sales"
        if ((-not $inConsulting) -and $inSales) {
          @{ pass = $true; reason = "consult.user1 not in Consulting, in Sales" }
        } else {
          $reasons = @()
          if ($inConsulting) { $reasons += "still in Consulting" }
          if (-not $inSales) { $reasons += "not in Sales" }
          @{ pass = $false; reason = "consult.user1: " + ($reasons -join ", ") }
        }
      } catch {
        @{ pass = $false; reason = "consult.user1 not found: $_" }
      }
  register: m2_l22

- name: "M2 L2.3 - Check fin.user1 disabled, in Terminated OU, stripped groups"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "fin.user1" -Properties Enabled,DistinguishedName,MemberOf -ErrorAction Stop
        $disabled = -not $u.Enabled
        $inTermOU = $u.DistinguishedName -match "OU=Terminated"
        $groups = @($u.MemberOf | ForEach-Object { (Get-ADGroup $_).Name } | Where-Object { $_ -ne "Domain Users" })
        $stripped = $groups.Count -eq 0
        if ($disabled -and $inTermOU -and $stripped) {
          @{ pass = $true; reason = "fin.user1 disabled, in Terminated OU, groups stripped" }
        } else {
          $reasons = @()
          if (-not $disabled) { $reasons += "still enabled" }
          if (-not $inTermOU) { $reasons += "not in Terminated OU (DN=$($u.DistinguishedName))" }
          if (-not $stripped) { $reasons += "still has groups: $($groups -join ',')" }
          @{ pass = $false; reason = "fin.user1: " + ($reasons -join ", ") }
        }
      } catch {
        @{ pass = $false; reason = "fin.user1 not found: $_" }
      }
  register: m2_l23

- name: "M3 L3.1 - Check sales.user1 DN contains correct OU"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "sales.user1" -Properties DistinguishedName -ErrorAction Stop
        $inSalesOU = $u.DistinguishedName -match "OU=Sales"
        if ($inSalesOU) {
          @{ pass = $true; reason = "sales.user1 in Sales OU: $($u.DistinguishedName)" }
        } else {
          @{ pass = $false; reason = "sales.user1 not in Sales OU: $($u.DistinguishedName)" }
        }
      } catch {
        @{ pass = $false; reason = "sales.user1 not found: $_" }
      }
  register: m3_l31

- name: "M3 L3.3 - Delegation check (not implemented)"
  ansible.builtin.set_fact:
    m3_l33_result:
      output:
        - pass: false
          reason: "not implemented"

- name: "M4 L4.1 - Check contractor.user1 disabled or expiration set"
  ansible.windows.win_powershell:
    script: |
      try {
        $u = Get-ADUser -Identity "contractor.user1" -Properties Enabled,AccountExpirationDate -ErrorAction Stop
        $disabled = -not $u.Enabled
        $hasExpiry = $null -ne $u.AccountExpirationDate
        if ($disabled -or $hasExpiry) {
          $reasons = @()
          if ($disabled) { $reasons += "disabled" }
          if ($hasExpiry) { $reasons += "expiry=$($u.AccountExpirationDate)" }
          @{ pass = $true; reason = "contractor.user1: " + ($reasons -join ", ") }
        } else {
          @{ pass = $false; reason = "contractor.user1 still enabled with no expiry" }
        }
      } catch {
        @{ pass = $false; reason = "contractor.user1 not found: $_" }
      }
  register: m4_l41

- name: Consolidate DC results
  ansible.builtin.set_fact:
    dc_results:
      L1.1: "{{ m1_l11.output[0] }}"
      L1.2: "{{ m1_l12.output[0] }}"
      L1.3: "{{ m1_l13.output[0] }}"
      L2.1: "{{ m2_l21.output[0] }}"
      L2.2: "{{ m2_l22.output[0] }}"
      L2.3: "{{ m2_l23.output[0] }}"
      L3.1: "{{ m3_l31.output[0] }}"
      L3.3: "{{ m3_l33_result.output[0] }}"
      L4.1: "{{ m4_l41.output[0] }}"
