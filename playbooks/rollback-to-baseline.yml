---
- name: "Reset Labs: Roll Back to Clean Baseline"
  hosts: pve
  gather_facts: false
  vars:
    snapshot_name: "Student-Baseline"
    vm_ids: [200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219]

  tasks:
    - name: Verify snapshot exists on each VM
      ansible.builtin.shell: |
        qm listsnapshot {{ item }} | awk '{print $1}' | grep -x "{{ snapshot_name }}"
      args:
        executable: /bin/bash
      register: snap_check
      changed_when: false
      failed_when: snap_check.rc != 0
      loop: "{{ vm_ids }}"

    - name: Stop VMs before rollback
      ansible.builtin.shell: "qm stop {{ item }} --skiplock 1 || true"
      loop: "{{ vm_ids }}"
      changed_when: false

    - name: Wait for VMs to fully stop
      ansible.builtin.pause:
        seconds: 10

    - name: Rollback to snapshot
      ansible.builtin.shell: "qm rollback {{ item }} {{ snapshot_name }} --skiplock 1"
      loop: "{{ vm_ids }}"

    - name: Start VMs after rollback
      ansible.builtin.shell: "qm start {{ item }} --skiplock 1"
      loop: "{{ vm_ids }}"

    - name: Wait for VMs to boot
      ansible.builtin.pause:
        seconds: 30
